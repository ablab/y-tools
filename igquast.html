<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>IgQUAST by IgReC team</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <style type="text/css">
        .code {
            background-color: lightgray;
            white-space: pre-wrap;       /* css-3 */
            white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
        }
        .sc {
            /* font-variant: small-caps; */
        }
    </style>
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name" align=center>IgQUAST</h1>
      <h2 class="project-tagline" align=center>A tool for full-length antibody/TCR repertoires quality assessment</h2>
      IgQUAST is a part of <a href="https://github.com/yana-safonova/ig_repertoire_constructor" style="color:white;font-weight:bold;text-decoration: underline">IgReC</a> toolkit.
      Use the <a href="index.html" style="color:white;font-weight:bold;text-decoration: underline">main page</a> for download
    </section>

    <section class="main-content">
        <h2 id = "motivation">Motivation and purposes</h2>
        <p align = "justify">
            Construction of an antibody repertoire is a preliminary step of any immunological analysis based on Rep-seq reads.
            In the last few years at least three tools were released to address this problem:
            IgRepertoireConstructor by Safonova et al (2015),
            MiXCR by Bolotin et al. (2015) and pRESTO by Vander Heiden et al. (2014).
            However, no conventional quality assessment methodology was proposed yet.
            Without such methodology we cannot compare tools and determine their limitations.
        </p>

        <p align = "justify">
            We developed IgQUAST (<b>I</b>mmuno<b>G</b>lobulin <b>QU</b>ality
            <b>AS</b>sesstment <b>T</b>ool), a tool for benchmarking of full-length adaptive immune
            repertoire construction tools and quality assessment of adaptive immune repertoires.
        </p>

        <p align = "justify">
        IgQUAST has the following features (explained in details in further sections):
            <ol>
                <li> <i>Reference-based</i> and <i>reference-free</i> repertoire quality assessment;</li>
                <li> <i>Overcorrection/undercorrection</i> detection;</li>
                <li> Analysis of antibody <i>abundances;</i></li>
                <li> Detection of sequencing technology and repertoire construction strategy artifacts.</li>
            </ol>
        </p>


        <h2 id = "quality_assessment_scenarios">Quality assessment scenarios</h2>
        <p align = "justify">
            IgQUAST input:
            <ul>
                <li>Initial Rep-seq read library;</li>
                <li>Analyzed adaptive immune repertoire constructed on this library;</li>
                <li>For reference-based analysis, the reference repertoire constructed on the same library.</li>
            </ul>

            Both constructed and reference repertoires should be presented by two files:
            <ul>
                <li>Repertoire sequences along with their <i>abundances</i> (the number of reads formed the cluster);</li>
                <li>Map from initial reads to the corresponding clusters (read-to-cluster map, RCM).</li>
            </ul>
            Input reads file, Repertoire sequences file, and RCM file should be consistent.

            See detailed input requirements in <a href="igquast_manual.html#igquast_input">IgQUAST manual.</a>

            <p>
            <i>Note:</i>  IgQUAST benchmarks only the repertoire construction stage.
            Input reads should be already merged, filtered from contaminations, and cropped by V/J ends.
        </p>

        <p align = "justify">
            <font class="sc">IgQUAST</font> performs reference-based and reference-free analysis:
            <ul>
                <li>During reference-based analysis the tool compares two input repertoires: the <i>reference repertoire</i> and the <i>constructed repertoire.</i>
                    The analysis is separated into two scenarios:
                    <ul>
                        <li><b>Repertoire-to-repertoire matching</b> only uses repertoire sequences.
                            The tool aligns each of two repertoires against the other one and computes
                            <i>sensitivity</i> and <i>precision</i> metrics,
                            detects error positions in erroneously constructed sequences,
                            and compares reference and constructed abundances for ideally reconstructed sequences.
                            <!-- TODO reformulate -->
                        </li>
                        <li><b>Partition-based analysis</b> only uses partitions induced by the RCMs (read-to-cluster maps).
                            The tool compares two partitions and computes partition similarity metrics (like <i>Rand index</i>).
                            Also it computes cluster quality measures (like <i>purity</i> and <i>discordance</i>) and plots their distributions for both input repertoires.
                            <!-- TODO reformulate -->
                        </li>
                    </ul>
                </li>
                <li><b>Reference-free analysis</b> is performed on the constructed repertoire.
                    The tool detects overestimated clusters in the repertoire
                    using amplification-free Poisson model.
                    It also estimates error rate and error profile of the initial read library.
                    The same analysis is performed on the reference repertoire if it is provided.
                    All reference-free analysis requires both repertoire sequences and read-to-cluster map (RCM).
                </li>
            </ul>
        </p>

        <p align = "justify">
            The output IgQUAST is a collection of plots
            along with numerical statistics that are described below.
            Brief report is outputted to screen and saved to text log file.
            All computed metrics along with additional information (e.g. the data to reproduce some of plots) are exported into JSON.

            Table below summarizes scenarios requirements and results.
        </p>

        <p align = "justify">
        <table>
        <tr>
            <td align="center">
                <b>Scenario</b>
            </td>
            <td align="center">
                <b>Requirements</b>
            </td>
            <td align="center">
                <b>Resultant output</b>
            </td>
        </tr>
        <tr>
            <td>
                <a href="#repertoire_to_repertoire_matching">Repertoire-to-repertoire matching</a>
            </td>
            <td>
                Constructed and reference repertoires in
                <a href="ig_repertoire_constructor_manual.html#clusters_fasta">CLUSTER.FA format</a>
            </td>
            <td>
                Plots:
                <ul>
                    <li><a href="#distance_distributions">constructed-to-reference and reference-to-constructed distance distributions;</a></li>
                    <li><a href="#error_position_distribution">error position distribution;</a></li>
                    <li><a href="#sensitivity_precision">sensitivity-precision (optimal <i>constructed min-size</i> selection);</a></li>
                    <li><a href="#abundance_distributions">abundance distributions;</a></li>
                    <li><a href="#cluster_abundances_scatterplot">cluster abundances scatterplot;</a></li>
                </ul>

                Statistics:
                <ul>
                    <li><a href="#extra_clusters_stats">#extra clusters of different size;</a></li>
                    <li><a href="#sensitivity_precision_stats">sensitivity/precision;</a></li>
                    <li><a href="#sensitivity_precision_stats">optimal sensitivity+precision, optimal constructed min-size;</a></li>
                    <li><a href="#sensitivity_precision_stats">area under sensitivity-precision curve (AUC);</a></li>
                    <li><a href="#cluster_abundances_stats">abundance median rate;</a></li>
                </ul>
            </td>
        </tr>
        <tr>
            <td>
                <a href="#partition_based_analysis">Partition-based analysis</a>
            </td>
            <td>
                Initial input Rep-seq library,
                <a href="ig_repertoire_constructor_manual.html#read_cluster_map">RCM</a> files for
                the reference and the constructed repertoires
            </td>
            <td>
                Plots:
                <ul>
                    <li><a href="#cluster_purity_discordance_distributions">Constructed and reference purity distribution;</a></li>
                    <li><a href="#cluster_purity_discordance_distributions">Constructed and reference discordance distribution;</a></li>
                </ul>

                Statistics:
                <ul>
                    <li><a href="#clustering_similarity_measures">Clustering similarity measures (Jaccard index, Fowlkes-Mallows index, Rand index, adjusted Rand index);</a></li>
                    <li><a href="#partition_based_stats">Overcorrection measures (#pure/impure constructed clusters, #constructed discordant reads);</a></li>
                    <li><a href="#partition_based_stats">Undercorrection measures (#pure/impure reference clusters, #reference discordant reads)</a></li>
                </ul>
            </td>
        </tr>
        <tr>
            <td>
                <a href="#reference_free_analysis">Reference-free analysis</a>
            </td>
            <td>
                Initial input Rep-seq library, constructed repertoire
                <a href="ig_repertoire_constructor_manual.html#read_cluster_map">RCM</a> file
            </td>
            <td>
                Plots:
                <ul>
                    <li><a href="#error_discordance_profiles">error and discordance profiles (for entire repertoire and for 5 largets clusters);</a></li>
                    <li><a href="#distribution_of_errors_in_reads">distribution of #errors in reads;</a></li>
                    <li><a href="#constructed_max_error_scatter">scatterplot of max error over position against cluster size</a></li>
                </ul>

                Statistics:
                <ul>
                    <li><a href="#error_rate_stats">error rate estimation</a></li>
                </ul>

                <a href="#overcorrected_ids">Suspicious cluster IDs</a>
            </td>
        </tr>
        </table>
        </p>

        <p align = "justify">
            Certain scenarios are disabled by default since they are time- and memory-consuming.
            See <a href="igquast_manual.html#igquast_scenarios_options">IgQUAST manual</a> for command line options description.
        </p>

        <h2 id = "reference">Reference repertoire</h2>
        <p align = "justify">
            Reference repertoire is obtained either by
            repertoire simulation or by construction of the repertoire using
            the barcoding data and running repertoire construction in
            the <i>blind</i> (ignoring barcodes) mode.
        </p>

        <h3 id = "simulation">Simulation</h3>
        <p align = "justify">
            There are no special requirements for simulation software or/and simulated repertoire.
            However, we suggest using our <a href = 'http://yana-safonova.github.io/ig_simulator/'>IgSimulator</a> tool
            that was specially designed for benchmarking adaptive immune repertoire construction strategies.
        </p>

        <h3 id = "umi">Molecular barcoding</h3>
        <p align = "justify">
            Molecular identifiers (UMIs) or <i>barcodes</i> can be used for B-cell labeling.
            Such labeling allows one to reconstruct adaptive immune sequences using consensus by groups
            and, thus, provides one with a reference dataset for benchmarking.
        </p>

        <p align = "justify">
            Please note that currently available barcoding techniques are not perfect.
            Thus, using naive barcode assembly approach may lead to imprecise reference and biased analysis.
            The better option is to use a special tool designed for barcode-assisted antibody repertoire construction.
            We suggest using our <a href="barcodedIgReC.html">BarIgReC</a> tool for this.
        </p>

        <p align = "justify">
            Another approach to consider barcoding artifacts is to use specially designed semi-artificial test datasets.
            Such datasets are obtained by utmost aggressive input read and barcode filtering:
            all suspicious barcodes and reads are omitted.
            Such an approach is definitely improper for real-life repertoire construction
            (a significant part of repertoire diversity is lost),
            but is appropriate for test dataset preparation.
        </p>

        <h2 id="minsize_story">Cluster abundance threshold</h2>
        <p align = "justify">
            Distribution of antibody abundances is usually highly uneven.
            Most clusters in a repertoire have small size.
            Note that consensus computed on a small cluster is unreliable.
            Additionally, due to the dependence of amplification errors and/or special sequencing errors pattern
            even larger cluster could be unreliable.
        </p>

        <p align = "justify">
            Thus, we have to exclude small clusters from the analysis in order to make results more stable and interpretable.
            The threshold for reference cluster size (<i>reference min-size</i>) is a <b>parameter of benchmarking procedure.</b>
            IgQUAST uses 5 as a default value. See <a href="#citations">the paper</a> for more information about this choice.
        </p>

        <p align = "justify">
            At the same time, during real-life repertoire construction one have to choose a threshold
            for constructed cluster size. Constructed cluster size threshold (<i>constructed min-size</i>)
            is a <b>parameter of repertoire construction procedure.</b>
            The selection is tricky since the larger threshold, the less detailed but more trustworthy result.
            One have to find the optimal (in some sense) threshold value, the concrete optimality criterion depends
            mostly on the final purpose of the research.
        </p>


        <p align = "justify">
            For different repertoire construction strategies optimal (in any sense) threshold values can be different.
            Due to this reason, IgQUAST computes statistics for various threshold values.
            However, for good repertoire construction tool that does not underestimate abundances
            (see the <a href="#cluster_abundances_scatterplot">corresponding section</a> for more information about abundance estimation)
            we can expect that optimal <i>constructed min-size</i> is equal or close to
            the <i>reference min-size</i>.
        </p>

        <h2 id = "repertoire_to_repertoire_matching">Repertoire-to-repertoire matching</h2>
        <p align = "justify">
            Let us describe the provided comparison between reference and constructed repertoire in terms of their sequences.
        </p>

        <h3 id = "distance_distributions">Constructed-to-reference and reference-to-constructed distance distributions</h3>
        <p align = "justify">
            For each sequence in the constructed repertoire IgQUAST finds the closest sequence in the reference repertoire
            and constructs histogram of distances.
            It also constructs the same histogram by mapping the reference repertoire to
            the constructed one.
        </p>

        <p align = "justify">
            IgQUAST constructs these histograms for different <i>constructed min-size</i> values (1, 3, 5, 10) and for fixed
            <i>reference min-size</i> (5 by default).
        </p>

        <p align = "justify" id="distance_distributions_fig">
        <table align = center>
            <tr>
                <td align = center>
                    <img src = "docs/igquast/reference_based_bad/constructed_to_reference_distance_distribution_size_5.svg"
                                     width = 100%
                                     alt = "Constructed-to-reference distance distribution, reference min-size = constructed min-size = 5">
                </td>
                <td align = center>
                    <img src = "docs/igquast/octoplot.svg"
                                     width = 100%
                                     alt = "Reference-to-constructed (sensitivity) and constructed-to-reference (precision) distance distributions for reference min-size = 5 and various constructed min-sizes">
                </td>
            </tr>
            <tr>
                <td>
                    Reference-to-constructed distance distribution;<br> <i>reference min-size</i> = <i>constructed min-size</i> = 5.
                </td>
                <td>
                    Reference-to-constructed (sensitivity) and constructed-to-reference (precision) distance distributions; <br>  <i>reference min-size</i> = 5 and various <i>constructed min-sizes</i>.
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
            <i>Note:</i> one should necessarily inspect plots for different <i>min-size</i> values,
            since small clusters are probably imperfect and should be excluded from the analysis.
            However, the paramount pair of plots is the third one where <i>constructed min-size</i> = <i>reference min_size</i>.
            For a good repertoire construction tool
            we expect optimal <i>constructed min-size</i> to be close to
            <i>reference min-size</i>.
        </p>

        <p align = "justify">
            Plots above suggest that approx. 20% of repertoire sequences possess one error.
            We will investigate them in greater detail in the next section.
            <!-- <a href="#error_position_distribution">further.</a> -->
        </p>


        <h4 id="extra_clusters_stats">Reported statistics</h4>
        <p align = "justify">
            <i>Extra</i> cluster is a cluster from the constructed repertoire with size more or equal to <i>constructed min size</i>
            having not enough abundance (less than <i>reference min-size</i> or not presented) in the reference repertoire.
            IgQUAST group such extra clusters by their reference abundance (if cluster is not presented in the reference repertoire at all, define its reference abundance as zero)
            and reports the frequencies.
            This diagnostic allows one to estimate the impact of correctly reconstructed sequences with overestimated abundance.
        </p>

        <p align = "justify">
            For the example above the frequencies are the following:
            <pre class="code">
<code>
Extra clusters with size == 4:          57
Extra clusters with size == 3:          63
Extra clusters with size == 2:          36
Extra clusters with size == 1:          75
Extra clusters with size == 0:          4784</code>
            </pre>
            That means only a small part of extra clusters are real reference clusters with overestimated size.
            Other are just erroneous.
        </p>



        <h3 id = "error_position_distribution">Error position distribution</h3>
        <p align = "justify">
            For &ldquo;almost correct&rdquo; (matched with only one error, i.e.
            corresponded to the second red bar in the left figure <a href="#distance_distributions_fig">above</a>)
            constructed clusters IgQUAST plots error-position distribution (error profile).
            For this analysis IgQUAST uses <i>constructed min-size</i> equal to the <i>reference min-size,</i>
            that is 5 by default.
        </p>

        <p align = "justify">
            Such analysis can reveal sequencing technology or repertoire construction strategy artifacts.
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/error_pos_dist_FR4.svg"
                                     width = 100%
                                     alt = "Error position distribution for &ldquo;almost correct&rdquo; constructed sequences. Errors are concentrated in FR4 region">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/error_pos_dist_after_corection.svg"
                                     width = 100%
                                     alt = "After FR4 correction errors are evenly distributed">
                </td>
            </tr>
            <tr>
                <td>
                    Error position distribution for &ldquo;almost correct&rdquo; constructed sequences.<br>
                    Errors are concentrated in FR4 region.
                </td>
                <td>
                    After FR4 correction errors are evenly distributed.
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
            Plot above reveals that errors are mostly concentrated in FR4.
            Additional analysis shows the key reason for this is extremely high error rate at the end of reads
            for the considered Rep-seq library.
            Fortunately, it could be easily fixed using V/D/J gene germline
            (e.g. <a href="http://www.imgt.org/genedb/">IMGT</a>) database.
            FR4 is a conservative region and we hopefully do not miss any variations.
        </p>

        <p align = "justify">
            Our alignment tool <font class="sc">VJFinder</font> automatically fixes FR1 and FR4 during Rep-seq reads alignment.
            Thus, such artifacts is not an issue for IgReC.
        </p>


        <h3 id = "sensitivity_precision">Sensitivity and precision</h3>
        <p align = "justify">
            For one predefined <i>reference min-size</i> value (5 by default)
            and various <i>constructed min-size</i> values IgQUAST finds ideally reconstructed
            (i.e. matched without errors) clusters and compute the following metrics:
            <ul>
                <li><b>Precision</b> &mdash; rate of ideal clusters among constructed clusters.
                    This is a measure of repertoire <i>clearness.</i>
                    The larger the precision metric, the less the number of false constructed clusters.</li>
                <li><b>Sensitivity</b> &mdash; rate of ideal clusters among reference clusters.
                    This is a measure of repertoire <i>representativity.</i>
                    The larger the sensitivity metric, the more correct clusters were reconstructed.</li>
            </ul>
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50 %>
                    <img src = "docs/igquast/sensitivity_precision_definition.svg"
                                          width = 100%
                                          alt = "Sensitivity and precision definition">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/sens_prec_plot.png"
                                          width = 100%
                                          alt = "Sensitivity-precision plot example">
                </td>
            </tr>
            <tr>
                <td>
                    Sensitivity and precision definition.
                </td>
                <td>
                    Composition of sensitivity-precision plots for three different repertoire construction tools.
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
            The larger <i>constructed min-size</i>, the less <i>sensitivity</i> (since constructed repertoire is shrinking), and
            typically the more <i>precision</i> (since larger clusters are more reliable).
            Therefore, selection of <i>constructed min-size</i> is a trade-off between sensitivity and precision.
        </p>

        <p align = "justify">
            Sensitivity-precision curve (similar to ROC-curve) depicted above helps one to compare different tools.
            For example above IgReC (blue curve) dominates for all reasonable threshold values.
            Consequently, IgReC is the best option in this particular case.
        </p>

        <h4 id="sensitivity_precision_stats">Reported statistics</h4>
        IgQUAST reports:
        <ul>
            <li>sensitivity and precision for <i>constructed min-size</i> equal to <i>reference min-size</i> and
                for <i>optimal</i> (in terms of sum of sensitivity and precision) <i>constructed min-size</i> value along with the value
                itself;</li>
            <li>area under sensitivity-precision curve that can be used is numeric one-value quality metric;</li>
        </ul>

        <h3 id = "abundance_distributions">Abundance distributions</h3>
        <p align = "justify">
            Repertoire clusters are also characterized by their abundances, i.e., cluster sizes.
            IgReC plots superposed abundance histograms.
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50 %>
                    <img src = "docs/igquast/abundance_distributions.svg">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/abundance_distributions_log.svg">
                </td>
            </tr>
            <tr>
                <td>
                    Distributions of abundances for both input repertoires.
                </td>
                <td>
                    The same plot in logarithmic scale.
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
            Note that the histograms are more informative in log-scale
            due to high unevenness of antibody abundance distribution.
        </p>

        <p align = "justify">
            The plots above reveal that the constructed repertoire contains about 4 times more
            small clusters.
            A repertoire construction tool often fails to fix highly corrupted reads and
            such reads typically become singletons.
            Thus, the most part of small clusters have size 1.
            <!-- IDEA. Plot the hist only for large (>=5) clusters -->
        </p>

        <h3 id = "cluster_abundances_scatterplot">Cluster abundances scatterplot</h3>
        <p align = "justify">
            Repertoire clusters are also characterized by their abundances.
            For clusters presented in both constructed and reference repertoires (so-called <i>ideal clusters</i>),
            IgQUAST compares abundances.
        </p>

        <p align = "justify">
            A repertoire construction tool often fails to fix highly corrupted reads and such reads typically become singletons.
            Therefore, abundances of corresponding clusters are commonly underestimated.
        </p>

        <p align = "justify">
            According to our experiments, the dependence between reference and constructed cluster size is almost linear.
            The linear coefficient depends on error rate and repertoire construction strategy.
            We can use this coefficient to compare different repertoire construction tools.
        </p>

        <p align = "justify">
            For certain clusters constructed abundance is much higher than the reference abundance.
            We suppose that such clusters are <i>overcorrected,</i> i.e., erroneously glued with other (probably smaller)
            clusters.
            Thus, their abundance is overestimated.

            The plot depicts potentially overcorrected clusters by red points, while other clusters are shown by blue ones.
        </p>


        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/cluster_partition.svg"
                            width = 100%
                            alt = "">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/cluster_abundances_scatterplot.png"
                            width = 100%
                            alt = "">
                </td>
            </tr>
            <tr>
                <td>
                    Repertoire construction tool cannot fix highly corrupted reads.
                    Therefore, cluster abundances are typically underestimated.
                </td>
                <td>
                    Cluster abundances scatterplot for poorly constructed repertoire.
                    Abundances are highly underestimated; also a lot of overcorrected (red) clusters.
                </td>
            </tr>
        </table>
        </p>

        <h4 id="cluster_abundances_stats">Reported statistics</h4>
        IgQUAST reports <i>median abundance rate</i> (the median of abundances rates) &mdash; an estimation of abundance underestimation coefficient.
        This metric can be used for repertoire construction tools benchmarking.

        <h2 id = "partition_based_analysis">Partition-based analysis</h2>
        <p align = "justify">
            Let us describe the provided comparison between reference and constructed repertoire in terms of their clustering partitions.
            That includes conventional clustering similarity measures and distributions of cluster purity and discordance.
        </p>

        <h3 id = "clustering_similarity_measures">Clustering similarity measures</h3>
        <p align = "justify">
            IgQUAST reports:
            <ul>
                <li>Jaccard index,</li>
                <li>Fowlkes-Mallows index,</li>
                <li>Rand index,</li>
                <li>adjusted Rand index.</li>
            </ul>

            All those measures are computed using large (>=5 by default) clusters only,
            since as already discussed <a href="#minsize_story">above,</a> small clusters should be excluded from analysis.
        </p>


        <h3 id = "cluster_purity_discordance_distributions">Cluster purity and discordance distributions</h3>

        <p align = "justify">
            For each constucted cluster <i>C</i>  IgQUAST computes <i>purity</i> and <i> discordance</i> &mdash;
            the rate of the first and second most presented reference cluster in <i>C</i> respectively (see the figure below).
            Symmetrically we define purity and discordance for reference clusters.
        </p>

        <p align = "justify">
            Constructed purity and discordance are the measures of the cluster <i>overcorrection.</i>
            If the constructed cluster is impure then it is probably combined from several erroneously
            joined reference clusters.
        </p>

        <p align = "justify">
            Reference purity and discordance are measures of the cluster <i>undercorrection.</i>
            If the reference cluster is impure then it is probably erroneously split into several constructed clusters.
        </p>

        <table align ="center">
            <tr>
                <td align = center>
                    <img src = "docs/igquast/over_under_correction.svg" width = 100%
                                     alt = "">
                </td>
            </tr>
            <tr>
                <td>
                    Purity and discordance definition for reference and constructed clusters.
                    Reads 7 and 8 (red) are called <i>discordant</i> for the constructed repertoire,
                    since they vote for the second popular cluster.
                </td>
        </table>

        <p align = "justify">
            IgQUAST plots histograms of purity and discordance distributions for reference and constructed clusters.
            As already discussed <a href="#minsize_story">above,</a> small clusters should be excluded from analysis.
            Thus, IgQUAST also plots histograms considering large (>= 5 by default) clusters only.
        </p>

        <p align = "justify">
            Plots below demonstrate the difference between poorly constructed and accurate repertoires.
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_based_bad/constructed_purity_distribution_large.svg"
                            width = 100%
                            alt="">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_based_good/constructed_purity_distribution_large.svg"
                            width = 100%
                            alt="">
                </td>
            </tr>
            <tr>
                <td colspan=2>
                    Distribution of purity for large (>= 5) reference clusters for
                    poorly constructed (left) and accurate (right) repertoire.
                    Left repertoire contain more pure clusters, but also more impure ones.
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
            <i>Note:</i> even if a constructed cluster is pure it does not necessarily imply that the cluster is correct.
            A pure cluster may be an erroneously separated
            part of a bigger cluster. We have to control both reference and construction purity.
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_based_bad/reference_purity_distribution_large.svg"
                            width = 100%
                            alt="">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_based_good/reference_purity_distribution_large.svg"
                            width = 100%
                            alt="">
                </td>
            </tr>
            <tr>
                <td colspan=2>
                    Distribution of purity of large (>= 5) reference clusters for
                    poorly constructed (left) and accurate (right) repertoire.
                    Left repertoire is undercorrected: there are a lot of impure reference clusters,
                    i.e., clusters that is erroneously split.
                </td>
            </tr>
        </table>
        </p>

        <h4 id="partition_based_stats">Reported statistics</h4>
        <p align = "justify">
            IgQUAST exports the number of pure/impure reference and constructed clusters (purity threshold is 95%) along with
            <i>the number of discordant reads</i> in for the reference and the constructed repertoires.
        </p>

        <h2 id = "reference_free_analysis">Reference-free analysis</h2>
        <p align = "justify">
            Reference-free analysis allows one to estimate quality of the constructed repertoire and the input library.
            In case of reference repertoire is provided, the same analysis is performed to it.
        </p>

        <h3 id = "distribution_of_errors_in_reads">Distribution of #errors in reads. Error-rate estimation</h3>
        <p align = "justify">
            For each initial read corresponding to large cluster (>=5 by default)
            IgQUAST computes the number of corrected errors as the Hamming
            distance from the corresponding repertoire sequence.
            Then it constructs histogram and estimates error rate
            (average number of sequencings errors per read) in Poisson amplification-free model.
            The histogram is plotted along with a histogram of Poisson distribution with parameter equal to the estimated
            error rate.
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_good/constructed_distribution_of_errors_in_reads.svg"
                            width = 100%
                            alt="">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_good/reference_distribution_of_errors_in_reads.svg"
                            width = 100%
                            alt="">
                </td>
            </tr>
            <tr>
                <td colspan=2>
                    Distribution of #errors in reads for the constructed (left) and the reference (right)
                    repertoire for simulated Rep-seq dataset. The actual error rate is 2.
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
            Example above suggests that for the constructed repertoire the distribution is far from Poisson (the tail is cut).
            The reason is that repertoire construction algorithm commonly fails to fix highly corrupted reads, therefore, high
            distances are improbable.

            At the same time, error rate is estimated correctly (the actual value is 2).
        </p>

        <p align = "justify">
            For the reference repertoire distance distribution is almost perfect Poisson since the data was simulated
            according to Poisson model, i.e. we suppose that sequencing errors are (1) rare and (2) independent.
            Note that in case of intensive amplification (2) may be not fulfilled.
        </p>

        <h4 id="error_rate_stats">Reported statistics</h4>
        <p align = "justify">
            IgQUAST reports the estimated error rate.
            Note that the estimation is reliable only if the repertoire is constructed properly.
            Therefore, using reference repertoire provides more adequate estimation.
        </p>

        <h3 id = "error_discordance_profiles">Error and discordance profiles</h3>
        <p align = "justify">
            For each large cluster (>=5 by default) for each sequence position IgQUAST computes <i>consensus</i>
            and finds quantity of the most popular letter and quantity of the second popular letter.
            Then, for each position it computes <i>error rate</i> (one minus the rate of the most popular letters) and
            <i>discordance</i> (the rate of second popular letter). IgQUAST plots error rate and discordance profiles, that help
            to detect overcorrection. Erroneously joined similar clusters provide peaks at the plot on the positions, where cluster sequences are different (see the example below).
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_bad/constructed_cluster_error_profile.svg"
                            width = 100%
                            alt="">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_good/constructed_cluster_error_profile.svg"
                            width = 100%
                            alt="">
                </td>
            </tr>
            <tr>
                <td colspan=2>
                    Error profiles for repertoires constructed by IgReC in aggressive mode (left)
                    and default mode (right).
                    Left repertoire is overcorrected.
                    Peaks on the left plot correspond to positions with differences.
                    <!-- (with <code>&#45;&#45;create&#45;triv&#45;dec</code>) -->
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_bad/constructed_cluster_discordance_profile.svg"
                            width = 100%
                            alt="">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_good/constructed_cluster_discordance_profile.svg"
                            width = 100%
                            alt="">
                </td>
            </tr>
            <tr>
                <td colspan=2>
                    Discordance profiles for the same repertoires.
                    Discordance profiles demonstrates the same behavior as error profiles.
                    At the time, discordance may be more informative in case if one wants two separate TWO close clusters.
                </td>
            </tr>
        </table>
        </p>

        <p align = "justify">
            IgQUAST also constructs profiles for 5 largest clusters separately, since in overcorrected repertoire largest clusters
            are often a union of several reference clusters.
        </p>

        <p align = "justify">
            <i>Note:</i> for highly accurate (or reference) repertoire error profile is an estimation of sequencing error profile of the Rep-seq library.
        </p>

        <h3 id = "constructed_max_error_scatter">Scatterplot of max error over position against cluster size</h3>
        For each cluster IgQUAST constructs error profile (as described in the previous section) and finds the position with maximal error.
        Then IgQUAST constructs scatterplot of the maximal number of errors over position against cluster size.
        Clusters with relatively large maximal number of errors are untrustworthy (shown by red points).
        <table align = center>
            <tr>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_bad/constructed_estimation_of_max_error_distribution.svg"
                            width = 100%
                            alt="">
                </td>
                <td align = center width = 50%>
                    <img src = "docs/igquast/reference_free_good/constructed_estimation_of_max_error_distribution.svg"
                            width = 100%
                            alt="">
                </td>
            </tr>
            <tr>
                <td colspan=2>
                    Scatterplots of maximal error position along sequence against cluster size
                    for repertoires constructed by IgReC in aggressive (left) and default (right) mode.
                    Red points correspond to potentially overcorrected clusters with extremely high number
                    of errors in one position. Dashed lines show 95% confidence interval in Poisson amplification-free
                    model.
                </td>
            </tr>
        </table>

        <p id = "overcorrected_ids" align = "justify">
            IDs of potentially overcorrected clusters are exported into JSON report file.
            Note that Poisson model may be imprecise in case of intensive amplification.
            The proper model taking amplification into account is being developed now.
        </p>

        <h2 id="feedback">Feedback and bug reports</h2>
        Your comments, bug reports, and suggestions are very welcome. They will help us to further improve IgQUAST.
        <br><br> If you have any trouble running IgQUAST, please provide us the log file from the output directory.
        <br><br> Address for communications: <a href="mailto:igtools_support@googlegroups.com">igtools_support@googlegroups.com</a>.


        <h2 id = "manuals_and_citations">Manuals and citations</h2>
        <h3>Manuals</h3>
        IgQUAST manual can be found <a href = "igquast_manual.html">here</a></li>.


        <h3 id = "citations">Citations</h3>
        <p align = "justify">
            Alexander Shlemov, Sergey Bankevich, Andrey Bzikadze,
            Dmitriy M. Chudakov,
            Yana Safonova,
            and Pavel A. Pevzner.
            Reconstructing antibody repertoires from error-prone immunosequencing datasets <i>(submitted)</i>
        </p>

      <footer class="site-footer">
        <span class="site-footer-owner">
            <a href="https://github.com/yana-safonova/ig_repertoire_constructor">IgReC</a> is maintained by
            Center for Algorithmic Biotechnology, Saint Petersburg University
        </span>
      </footer>

    </section>

  </body>
</html>
